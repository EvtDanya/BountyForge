{% extends "base.html" %}
{% block content %}
  <div class="mb-4">
    <h2>Dashboard</h2>
    <p>Welcome to BountyForge. Monitor your scan status, view statistics, and manage your scans here.</p>
    <!-- Buttons -->
    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#launchScanModal">
      <i class="fas fa-play me-2"></i>Launch Scan
    </button>
    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#hostsModal">
      <i class="fas fa-file-code me-2"></i>Edit Hosts
    </button>
  </div>

  <!-- Notification area -->
  <div id="notificationArea"></div>

  <div class="row">
    <!-- System Status card -->
    <div class="col-lg-4 col-md-6 mb-3">
      <div class="card text-white bg-primary h-100 shadow-sm">
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0"><i class="fas fa-signal me-2"></i>System Status</h5>
            <button id="checkModulesBtn" class="btn btn-light btn-sm">
              <i class="fas fa-sync-alt"></i> Check Modules
            </button>
          </div>
          <small class="text-light mb-3">Click to verify that all scan modules are up.</small>
          <div id="moduleStatus" class="mt-auto"></div>
        </div>
      </div>
    </div>

    <!-- Last Scan card -->
    <div class="col-lg-4 col-md-6 mb-3">
      <div class="card text-white bg-success h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title"><i class="fas fa-rocket me-2"></i>Last Scan</h5>
          <p class="card-text">example.com – Nmap scan finished successfully.</p>
        </div>
      </div>
    </div>

    <!-- Statistics card -->
    <div class="col-lg-4 col-md-6 mb-3">
      <div class="card text-white bg-warning h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Statistics</h5>
          <p class="card-text">7 scans conducted today across 20 targets.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Launch Scan Modal -->
  <div class="modal fade" id="launchScanModal" tabindex="-1" aria-labelledby="launchScanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="scanForm">
          <div class="modal-header">
            <h5 class="modal-title" id="launchScanModalLabel">Launch Scan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Error alert for scan form -->
            <div id="scanFormAlert"></div>

            <!-- Target Type -->
            <div class="mb-3">
              <label for="target_type" class="form-label">Target Type:</label>
              <select class="form-select" id="target_type" name="target_type">
                <!-- <option value="single">Single</option> -->
                <option value="multiple">Single/Multiple</option>
                <option value="file">File (upload .txt)</option>
              </select>
            </div>

            <!-- Single target input -->
            <!-- <div class="mb-3" id="single_target_group">
              <label for="target_single" class="form-label">Target:</label>
              <input type="text" class="form-control" id="target_single" name="target" placeholder="example.com">
            </div> -->

            <!-- Multiple targets textarea -->
            <div class="mb-3" id="multiple_target_group">
              <label for="target_multiple" class="form-label">Target(-s) (one per line):</label>
              <textarea class="form-control" id="target_multiple" name="target_multiple" rows="5"
                        placeholder="example.com
test.com
sub.domain.com"></textarea>
            </div>

            <!-- File input for file mode -->
            <div class="mb-3 d-none" id="file_target_group">
              <label for="target_file" class="form-label">Upload targets file:</label>
              <input type="file" class="form-control" id="target_file" name="target_file" accept=".txt">
              <small class="form-text text-muted">One host/IP per line.</small>
            </div>

            <!-- Exclude Targets textarea -->
            <div class="mb-3">
              <label for="target_exclude" class="form-label">Exclude Targets (one per line):</label>
              <textarea class="form-control" id="target_exclude" name="target_exclude" rows="3"
                        placeholder="ignore.example.com
dev.internal.local"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Custom Headers:</label>
              <textarea 
                  class="form-control"
                  name="headers"
                  rows="3"
                  placeholder="X-API-Key: 12345
Authorization: Bearer token"></textarea>
              <small class="text-muted">По одному заголовку на строку в формате "Header: Value"</small>
            </div>

            <!-- Tool selection -->
            <h4>Select Tools</h4>
            <div class="mb-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="tool_nmap" name="tools" value="nmap">
                <label class="form-check-label" for="tool_nmap">Nmap</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="tool_subfinder" name="tools" value="subfinder">
                <label class="form-check-label" for="tool_subfinder">Subfinder</label>
              </div>
            </div>

            <!-- Nmap settings -->
            <!-- <div id="nmap_settings" class="mb-3 tool-settings d-none">
              <h5>Nmap Settings</h5>
              <div class="mb-2">
                <label class="form-label">Scan Mode:</label>
                <select class="form-select" name="nmap_mode">
                  <option value="default">Default</option>
                  <option value="aggressive">Aggressive</option>
                  <option value="full">Full</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Additional Flags:</label>
                <input type="text" class="form-control" name="nmap_flags" placeholder="-v">
              </div>
            </div> -->

            <!-- Subfinder settings -->
            <!-- <div id="subfinder_settings" class="mb-3 tool-settings d-none">
              <h5>Subfinder Settings</h5>
              <div class="mb-2">
                <label class="form-label">Additional Flags:</label>
                <input type="text" class="form-control" name="subfinder_flags" placeholder="">
              </div>
            </div> -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Start Scan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Hosts Modal -->
  <div class="modal fade" id="hostsModal" tabindex="-1" aria-labelledby="hostsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="hostsForm">
          <div class="modal-header">
            <h5 class="modal-title" id="hostsModalLabel">Edit /etc/hosts</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="hostsTextarea" class="form-label">Current /etc/hosts:</label>
              <textarea id="hostsTextarea" class="form-control" rows="15" readonly>Loading…</textarea>
            </div>
            <div id="hostsAlert"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Hosts</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scan result output -->
  <!-- <div id="scanResult" class="mt-4"></div> -->

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const CHECK_URL = "{{ api_check_modules_url }}";
      const HOSTS_URL = "{{ api_hosts_url }}";
      const SCAN_URL  = "{{ api_start_scan_url }}";
      const token     = "{{ session.jwt_token }}";

      // Helper to show Bootstrap alerts
      function showAlert(type, message) {
        const area = document.getElementById('notificationArea');
        area.innerHTML = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
      }

      // Check Modules logic
      const btnCheck   = document.getElementById('checkModulesBtn');
      const statusCont = document.getElementById('moduleStatus');
      btnCheck.addEventListener('click', async () => {
        btnCheck.disabled = true;
        btnCheck.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        statusCont.innerHTML = '';
        try {
          const res = await fetch(CHECK_URL, {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const ul = document.createElement('ul');
          ul.className = 'list-unstyled mb-0';
          Object.entries(data).forEach(([mod, info]) => {
            const li = document.createElement('li');
            li.className = 'd-flex justify-content-between align-items-center';
            
            const icon = info.available 
                ? '<i class="fas fa-check-circle text-success me-2"></i>' 
                : '<i class="fas fa-times-circle text-danger me-2"></i>';
            
            const versionText = info.version 
                ? `<span class="text-light ms-2">v${info.version}</span>` 
                : '<span class="text-danger">not available</span>';
            
            li.innerHTML = `
                <div class="d-flex align-items-center">
                    ${icon}
                    <span class="fw-bold text-nowrap">${mod}</span>
                </div>
                ${versionText}
            `;
            
            ul.appendChild(li);
          });
          statusCont.appendChild(ul);
        } catch (err) {
          console.error('Module check error:', err);
          showAlert('danger', `Error checking modules: ${err.message}`);
        } finally {
          btnCheck.disabled = false;
          btnCheck.innerHTML = '<i class="fas fa-sync-alt"></i> Check Modules';
        }
      });

      // Scan form logic
      const targetTypeEl      = document.getElementById('target_type');
      // const singleGroup       = document.getElementById('single_target_group');
      const multipleGroup     = document.getElementById('multiple_target_group');
      const fileGroup         = document.getElementById('file_target_group');
      const excludeEl         = document.getElementById('target_exclude');
      const scanForm          = document.getElementById('scanForm');
      // const scanResult        = document.getElementById('scanResult');
      const toolNmap          = document.getElementById('tool_nmap');
      const toolSubfinder     = document.getElementById('tool_subfinder');
      // const nmapSettings      = document.getElementById('nmap_settings');
      // const subfinderSettings = document.getElementById('subfinder_settings');
      const scanFormAlert     = document.getElementById('scanFormAlert');
 
      targetTypeEl.addEventListener('change', () => {
        // singleGroup.classList.toggle('d-none', targetTypeEl.value !== 'single');
        multipleGroup.classList.toggle('d-none', targetTypeEl.value !== 'multiple');
        fileGroup.classList.toggle('d-none', targetTypeEl.value !== 'file');
      });
      // targetTypeEl.dispatchEvent(new Event('change'));
      // toolNmap.addEventListener('change', () => {
      //   nmapSettings.classList.toggle('d-none', !toolNmap.checked);
      // });
      // toolSubfinder.addEventListener('change', () => {
      //   subfinderSettings.classList.toggle('d-none', !toolSubfinder.checked);
      // });

      scanForm.addEventListener('submit', async e => {
        e.preventDefault();
        scanFormAlert.innerHTML = '';  // clear previous errors

        let targets;
        let tt = targetTypeEl.value;

        try {
          if (tt === 'file') {
            const fileInput = document.getElementById('target_file');
            if (!fileInput.files.length) throw new Error('Please select a file');
            const fd = new FormData();
            fd.append('target_file', fileInput.files[0]);
            const up = await fetch('/upload_targets', {
              method: 'POST',
              credentials: 'include',
              body: fd
            });
            if (!up.ok) {
              const errJson = await up.json();
              throw new Error(errJson.error || 'File upload failed');
            }
            const jsonUp = await up.json();
            targets = jsonUp.targets;
            tt = 'multiple';
          } else if (tt === 'multiple') {
            const raw = document.getElementById('target_multiple').value.trim();
            if (!raw) throw new Error('Please enter targets');
            targets = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          } 
          // else {
          //   const raw = document.getElementById('target_single').value.trim();
          //   if (!raw) throw new Error('Please enter a target');
          //   targets = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          // }

          // Exclusions
          const exRaw = excludeEl.value.trim();
          const exclude = exRaw
            ? exRaw.split(/\r?\n/).map(s => s.trim()).filter(Boolean)
            : [];

          // Headers
          const headersText = scanForm.querySelector('textarea[name="headers"]').value.trim();
          const headers = {};
          if (headersText) {
              headersText.split('\n').forEach(line => {
                  const [key, ...values] = line.split(':');
                  if (key && values) {
                      headers[key.trim()] = values.join(':').trim();
                  }
              });
          }

          // Tools & params
          const tools = Array.from(scanForm.querySelectorAll('input[name="tools"]:checked'))
                             .map(chk => chk.value);
          // const params = {};
          // if (tools.includes('nmap')) {
          //   params.nmap = {
          //     scan_type: document.querySelector('select[name="nmap_mode"]').value,
          //     additional_flags: document.querySelector('input[name="nmap_flags"]').value
          //   };
          // }
          // if (tools.includes('subfinder')) {
          //   params.subfinder = {
          //     additional_flags: document.querySelector('input[name="subfinder_flags"]').value
          //   };
          // }

          const payload = {
            target: targets,
            exclude: exclude,
            target_type: tt,
            tools: tools
            // params: params
          };

          const res = await fetch(SCAN_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const errText = await res.text();
            let msg = errText;
            try { msg = JSON.parse(errText).error || errText } catch {}
            throw new Error(msg);
          }

          const result = await res.json();
          // scanResult.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
          bootstrap.Modal.getInstance(document.getElementById('launchScanModal')).hide();
          showAlert('success', `<pre>${JSON.stringify(result, null, 2)}</pre>`);
        } catch (err) {
          console.error('Scan error:', err);
          scanFormAlert.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
      });

      // Hosts editing logic
      const hostsModal    = document.getElementById('hostsModal');
      const hostsForm     = document.getElementById('hostsForm');
      const hostsTextarea = document.getElementById('hostsTextarea');
      const hostsAlert    = document.getElementById('hostsAlert');

      hostsModal.addEventListener('show.bs.modal', async () => {
        hostsAlert.innerHTML = '';
        hostsTextarea.value = 'Loading…';
        try {
          const res = await fetch(HOSTS_URL, {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const text = await res.text();
          if (!res.ok) {
            const parsed = JSON.parse(text);
            throw new Error(parsed.error || res.statusText);
          }
          const j = JSON.parse(text);
          hostsTextarea.value = j.hosts || '';
        } catch (e) {
          console.error('Hosts load error:', e);
          hostsTextarea.value = '';
          hostsAlert.innerHTML = `<div class="alert alert-danger">Error loading hosts: ${e.message}</div>`;
        }
      });

      hostsForm.addEventListener('submit', async e => {
        e.preventDefault();
        hostsAlert.innerHTML = '';
        try {
          const res = await fetch(HOSTS_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ hosts: hostsTextarea.value })
          });
          const text = await res.text();
          if (!res.ok) {
            const parsed = JSON.parse(text);
            throw new Error(parsed.error || res.statusText);
          }
          console.log('Hosts saved:', text);
          hostsAlert.innerHTML = '<div class="alert alert-success">Hosts updated successfully</div>';
        } catch (err) {
          console.error('Hosts save error:', err);
          hostsAlert.innerHTML = `<div class="alert alert-danger">Error saving hosts: ${err.message}</div>`;
        }
      });

      // Initialize Bootstrap popovers
      var popoverTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="popover"]')
      );
      popoverTriggerList.map(el => new bootstrap.Popover(el));
    });
  </script>
{% endblock %}
