{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">Settings</h1>
<div id="notificationArea"></div>
<form id="settingsForm" method="POST">
  <!-- Global Settings -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5><i class="fas fa-globe me-2"></i>Global Settings</h5>
    </div>
    <div class="card-body">
      <div class="mb-3 row">
        <label for="rate_limit" class="col-sm-3 col-form-label">Rate Limit (req/sec):</label>
        <div class="col-sm-9">
          <input
            type="number"
            class="form-control"
            id="rate_limit"
            name="rate_limit"
            min="1"
            required
            value=""
          >
        </div>
      </div>
      <div class="mb-3 row">
        <label for="timeout" class="col-sm-3 col-form-label">Timeout (sec):</label>
        <div class="col-sm-9">
          <input
            type="number"
            class="form-control"
            id="timeout"
            name="timeout"
            min="1"
            required
            value=""
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Nuclei Settings -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-dark text-white">
      <h5><i class="fas fa-bullseye me-2"></i>Nuclei Settings</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Scan Mode:</label>
        <div class="btn-group" role="group" aria-label="Nuclei Scan Mode">
          <input type="radio" class="btn-check" name="nuclei_mode" id="nuclei_default" value="default" autocomplete="off">
          <label class="btn btn-outline-primary" for="nuclei_default">Default</label>

          <input type="radio" class="btn-check" name="nuclei_mode" id="nuclei_aggressive" value="aggressive" autocomplete="off">
          <label class="btn btn-outline-primary" for="nuclei_aggressive">Aggressive</label>

          <input type="radio" class="btn-check" name="nuclei_mode" id="nuclei_full" value="full" autocomplete="off">
          <label class="btn btn-outline-primary" for="nuclei_full">Full</label>

          <button type="button" class="btn btn-outline-secondary"
                  data-bs-toggle="popover"
                  data-bs-trigger="hover focus"
                  data-bs-placement="right"
                  data-bs-content="Default: template subset. Aggressive: high rate. Full: all templates.">
            <i class="fas fa-question-circle"></i>
          </button>
        </div>
      </div>
      <div class="mb-3">
        <label for="nuclei_flags" class="form-label">Additional Flags:</label>
        <input type="text" class="form-control" id="nuclei_flags" name="nuclei_flags" value="">
      </div>
      <div class="mb-3">
        <label for="nuclei_templates" class="form-label">Templates Dir:</label>
        <input type="text" class="form-control" id="nuclei_templates" name="nuclei_templates" value="">
      </div>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" id="updateNucleiBtn">
          <i class="fas fa-sync"></i> Update Nuclei
        </button>
        <button type="button" class="btn btn-outline-primary" id="updateTemplatesBtn">
          <i class="fas fa-folder-open"></i> Update Templates
        </button>
      </div>
    </div>
  </div>
  
  <!-- Nmap Settings -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
      <h5><i class="fas fa-network-wired me-2"></i>Nmap Settings</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Scan Mode:</label>
        <div class="btn-group" role="group" aria-label="Nmap Scan Mode">
          <input type="radio" class="btn-check" name="nmap_mode" id="nmap_default" value="default" autocomplete="off">
          <label class="btn btn-outline-primary" for="nmap_default">Default</label>

          <input type="radio" class="btn-check" name="nmap_mode" id="nmap_aggressive" value="aggressive" autocomplete="off">
          <label class="btn btn-outline-primary" for="nmap_aggressive">Aggressive</label>

          <input type="radio" class="btn-check" name="nmap_mode" id="nmap_full" value="full" autocomplete="off">
          <label class="btn btn-outline-primary" for="nmap_full">Full</label>

          <button type="button" class="btn btn-outline-secondary"
                  data-bs-toggle="popover"
                  data-bs-trigger="hover focus"
                  data-bs-placement="right"
                  data-bs-content="Default: Standard. Aggressive: OS & version detection. Full: all ports.">
            <i class="fas fa-question-circle"></i>
          </button>
        </div>
      </div>
      <div class="mb-3">
        <label for="nmap_flags" class="form-label">Additional Flags:</label>
        <input type="text" class="form-control" id="nmap_flags" name="nmap_flags" value="">
      </div>
    </div>
  </div>

  <!-- Subfinder Settings -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white">
      <h5><i class="fas fa-search me-2"></i>Subfinder Settings</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label for="subfinder_flags" class="form-label">Additional Flags:</label>
        <input type="text" class="form-control" id="subfinder_flags" name="subfinder_flags" value="">
      </div>
    </div>
  </div>

  <!-- FFUF Settings (Subdomains + Directories) -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
      <h5><i class="fas fa-folder-open me-2"></i>FFUF Settings</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label for="ffuf_dns_wordlist" class="form-label">DNS Wordlist:</label>
        <select class="form-select" id="ffuf_dns_wordlist" name="ffuf_dns_wordlist"></select>
      </div>
      <div class="mb-3">
        <label for="ffuf_directories_wordlist" class="form-label">Directories Wordlist:</label>
        <select class="form-select" id="ffuf_directories_wordlist" name="ffuf_directories_wordlist"></select>
      </div>
      <div class="mb-3">
        <label for="ffuf_flags" class="form-label">Additional Flags:</label>
        <input type="text" class="form-control" id="ffuf_flags" name="ffuf_flags" value="">
      </div>
    </div>
  </div>

  <!-- HTTPX Settings -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning text-white">
      <h5><i class="fas fa-wifi me-2"></i>HTTPX Settings</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Mode:</label>
        <div class="btn-group" role="group" aria-label="HTTPX Mode">
          <input type="radio" class="btn-check" name="httpx_mode" id="httpx_recon" value="recon" autocomplete="off">
          <label class="btn btn-outline-primary" for="httpx_recon">Recon</label>

          <input type="radio" class="btn-check" name="httpx_mode" id="httpx_live" value="live" autocomplete="off">
          <label class="btn btn-outline-primary" for="httpx_live">Live</label>

          <button type="button" class="btn btn-outline-secondary"
                  data-bs-toggle="popover"
                  data-bs-trigger="hover focus"
                  data-bs-placement="right"
                  data-bs-content="Recon: detailed. Live: status only.">
            <i class="fas fa-question-circle"></i>
          </button>
        </div>
      </div>
      <div class="mb-3">
        <label for="httpx_flags" class="form-label">Additional Flags:</label>
        <input type="text" class="form-control" id="httpx_flags" name="httpx_flags" value="">
      </div>
    </div>
  </div>

  <button type="submit" class="btn btn-lg btn-success">
    <i class="fas fa-save me-2"></i>Save Settings
  </button>
</form>

<script>
  const BACKEND_GET_CONFIG = "{{ api_get_config_url }}";
  const BACKEND_SAVE_CONFIG = "{{ api_save_config_url }}";
  const BACKEND_UPDATE_NUCLEI = "{{ api_update_nuclei_url }}";
  const BACKEND_UPDATE_TEMPLATES = "{{ api_update_templates_url }}";
  const token = "{{ session.jwt_token }}";

  function showAlert(type, message) {
    document.getElementById('notificationArea').innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
  }
 
  document.addEventListener("DOMContentLoaded", () => {
    // Load existing config
    fetch(BACKEND_GET_CONFIG, {
      method: "GET",
      headers: { "Authorization": "Bearer " + token }
    })
    .then(r => r.json())
    .then(data => {
      // global
      document.getElementById("rate_limit").value = data.backend.rate_limit || "";
      document.getElementById("timeout").value = data.backend.timeout    || "";
      
      // nmap
      document.getElementById("nmap_" + data.scanners.nmap.mode)?.click();
      document.getElementById("nmap_flags").value = data.scanners.nmap.additional_flags || "";
      
      // subfinder
      document.getElementById("subfinder_flags").value = data.scanners.subfinder.additional_flags || "";
      
      // FFUF dns wordlist
      const dnsWL = data.scanners.available_wordlists.dns||[];
      const dnsSel= document.getElementById("ffuf_dns_wordlist");
      dnsWL.forEach(fp=>{
        const o=new Option(fp.replace("dns/",""),fp);
        dnsSel.add(o);
      });
      document.getElementById("ffuf_dns_wordlist").value = data.scanners.ffuf.dns_wordlist;

      // FFUF directories wordlist
      const dirWL = data.scanners.available_wordlists["web-content"]||[];
      const dirSel= document.getElementById("ffuf_directories_wordlist");
      dirWL.forEach(fp=>{
        const o=new Option(fp.replace("web-content/",""),fp);
        dirSel.add(o);
      });
      document.getElementById("ffuf_directories_wordlist").value = data.scanners.ffuf.directories_wordlist;

      // FFUF flags
      document.getElementById("ffuf_flags").value = (data.scanners.ffuf.additional_flags||[]).join(" ");

      // httpx
      document.getElementById("httpx_" + data.scanners.httpx.mode)?.click();
      document.getElementById("httpx_flags").value = data.scanners.httpx.additional_flags || "";
      // nuclei
      document.getElementById("nuclei_" + (data.scanners.nuclei.mode || "default"))?.click();
      document.getElementById("nuclei_flags").value     =
        (Array.isArray(data.scanners.nuclei.additional_flags)
          ? data.scanners.nuclei.additional_flags.join(" ")
          : data.scanners.nuclei.additional_flags) || "";
      document.getElementById("nuclei_templates").value = data.scanners.nuclei.templates_dir || "";
    });

    // Save settings
    document.getElementById("settingsForm").addEventListener("submit", e => {
      e.preventDefault();
      const payload = {
        backend: {
          rate_limit: Number(document.getElementById("rate_limit").value),
          timeout: Number(document.getElementById("timeout").value)
        },
        scanners: {
          nmap: {
            mode: document.querySelector("input[name='nmap_mode']:checked").value,
            additional_flags: document.getElementById("nmap_flags").value.split(/\s+/).filter(Boolean)
          },
          subfinder: {
            additional_flags: document.getElementById("subfinder_flags").value.split(/\s+/).filter(Boolean)
          },
          ffuf:{
            dns_wordlist: document.getElementById("ffuf_dns_wordlist").value,
            directories_wordlist: document.getElementById("ffuf_directories_wordlist").value,
            additional_flags: document.getElementById("ffuf_flags").value.split(/\s+/).filter(Boolean)
          },
          httpx: {
            mode: document.querySelector("input[name='httpx_mode']:checked").value,
            additional_flags:  document.getElementById("httpx_flags").value.split(/\s+/).filter(Boolean)
          },
          nuclei: {
            mode: document.querySelector("input[name='nuclei_mode']:checked").value,
            additional_flags: document.getElementById("nuclei_flags").value.split(/\s+/).filter(Boolean),
            templates_dir: document.getElementById("nuclei_templates").value
          }
        }
      };
      fetch(BACKEND_SAVE_CONFIG, {
        method: "POST",
        credentials: "include",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type":  "application/json"
        },
        body: JSON.stringify(payload)
      })
      .then(r => { 
        if (!r.ok) throw new Error("Failed to save");
         return r.json();
      })
      .then(() => {
        showAlert('success', 'Settings saved!');
        document
          .getElementById('notificationArea')
          .scrollIntoView({ behavior: 'smooth', block: 'start' });
      })
      .catch(
        err => {
          showAlert('danger', 'Error saving settings: ' + err.message);
          document
          .getElementById('notificationArea')
          .scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // Update Nuclei
    document.getElementById("updateNucleiBtn").addEventListener("click", async () => {
      const btn = document.getElementById("updateNucleiBtn");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating…';
      try {
        let res = await fetch(BACKEND_UPDATE_NUCLEI, {
          method: "POST",
          headers: { "Authorization": "Bearer " + token }
        });
        if (!res.ok) {
          const errText = await res.text();
          let msg = errText;
          try { msg = JSON.parse(errText).error || errText } catch {}
          throw new Error(msg);
        }
        let j = await res.json();
        showAlert('success', j.message || 'Nuclei updated');
        document
          .getElementById('notificationArea')
          .scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (e) {
        console.error(e);
        showAlert('danger', 'Error updating Nuclei: ' + e)
        document
          .getElementById('notificationArea')
          .scrollIntoView({ behavior: 'smooth', block: 'start' });
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> Update Nuclei';
      }
    });

    // Update Templates
    document.getElementById("updateTemplatesBtn").addEventListener("click", async () => {
      const btn = document.getElementById("updateTemplatesBtn");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating…';
      try {
        let res = await fetch(BACKEND_UPDATE_TEMPLATES, {
          method: "POST",
          headers: { "Authorization": "Bearer " + token }
        });
        if (!res.ok) {
          const errText = await res.text();
          let msg = errText;
          try { msg = JSON.parse(errText).error || errText } catch {}
          throw new Error(msg);
        }
        let j = await res.json();
        showAlert('success', j.message || 'Templates updated');
        document
          .getElementById('notificationArea')
          .scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (e) {
        console.error(e);
        showAlert('danger', 'Error updating templates: ' + e)
        document
          .getElementById('notificationArea')
          .scrollIntoView({ behavior: 'smooth', block: 'start' });
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-folder-open"></i> Update Templates';
      }
    });

    // Initialize all popovers
    var popoverTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="popover"]')
    );
    popoverTriggerList.map(el => new bootstrap.Popover(el));
  });
</script>
{% endblock %}
