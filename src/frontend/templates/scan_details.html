{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="row mb-3">
    <div class="col">
      <div class="d-flex justify-content-between align-items-center">
        <h2>Scan ID: {{ scan_id }}</h2>
        <span id="scanStatus" class="badge bg-secondary">Loading…</span>
      </div>
    </div>
  </div>

  <!-- Raw output panel -->
  <div class="row">
    <div class="col">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <i class="fas fa-terminal me-2"></i>Live Output
        </div>
        <div class="card-body p-3" style="background:#000; color:#0f0; height:400px; overflow:auto;">
          <pre id="rawOutput" class="mb-0"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const token = "{{ session.jwt_token }}";
document.addEventListener('DOMContentLoaded', async () => {
  const statusBadge = document.getElementById('scanStatus');
  const rawOut = document.getElementById('rawOutput');


  // 1) метаданные
  const metaRes = await fetch("{{ api_scan_meta_url }}", {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (!metaRes.ok) {
    statusBadge.textContent = 'Not found';
    statusBadge.className = 'badge bg-danger';
    return;
  }
  const meta = await metaRes.json();
  const { status } = meta;

  // 2) если уже finished, подтягиваем из БД
  if (status === 'finished') {
    statusBadge.textContent = 'Finished';
    statusBadge.className = 'badge bg-success';
    const resRes = await fetch("{{ api_scan_results_url }}", {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const results = await resRes.json();
    results.forEach(evt => {
      const line = document.createElement('div');
      line.textContent = `[${evt.tool}] ${evt.output||JSON.stringify(evt)}`;
      rawOut.appendChild(line);
    });
    return;
  }

  // 3) иначе — слушаем SSE
  statusBadge.textContent = 'Running';
  statusBadge.className = 'badge bg-info';
  const evtSource = new EventSource("{{ stream_url }}");

  evtSource.onmessage = e => {
    const evt = JSON.parse(e.data);
    switch(evt.event) {
      case 'started':
        console.info('Scan started');
        break;
      case 'result': {
        const line = document.createElement('div');
        line.textContent = `[${evt.tool}] ${evt.output||JSON.stringify(evt)}`;
        rawOut.appendChild(line);
        break;
      }
      case 'error':
        console.error(`[${evt.tool}] ERROR: ${evt.msg}`);
        break;
      case 'finished':
        console.info('Scan finished');
        statusBadge.textContent = 'Finished';
        statusBadge.className = 'badge bg-success';
        evtSource.close();
        break;
    }
  };

  evtSource.onerror = () => {
    statusBadge.textContent = 'Error';
    statusBadge.className = 'badge bg-danger';
    evtSource.close();
  };
});
</script>
{% endblock %}
