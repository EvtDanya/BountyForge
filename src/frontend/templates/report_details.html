{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Scan Report: {{ scan_id }}</h2>
    <span id="statusBadge" class="badge fs-6"></span>
  </div>

  <div class="row gx-4 gy-4">
    <div class="col-lg-6">
      <!-- Endpoints -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <i class="fas fa-bullseye me-2"></i>Endpoints
        </div>
        <ul class="list-group list-group-flush overflow-auto" id="targetsList"
            style="max-height: 70vh;"></ul>
      </div>
      <!-- Ports -->
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <i class="fas fa-network-wired me-2"></i>Discovered Ports
        </div>
        <div class="card-body p-0 overflow-auto" style="max-height: 70vh;">
          <div class="accordion" id="portsAccordion"></div>
        </div>
        <ul class="list-group list-group-flush overflow-auto" id="portsList"
            style="max-height: 70vh;"></ul>
      </div>
    </div>

    <!-- Statistics + Vulnerabilities -->
    <div class="col-lg-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <i class="fas fa-chart-pie me-2"></i>Statistics
        </div>
        <div class="card-body d-flex align-items-center justify-content-center">
          <canvas id="severityChart" style="max-width:100%; max-height:300px;"></canvas>
        </div>
      </div>
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <i class="fas fa-exclamation-triangle me-2"></i>Vulnerabilities
        </div>
        <div class="card-body p-0 overflow-auto" style="max-height: 70vh;">
          <div class="accordion" id="vulnAccordion"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function badgeClass(sev) {
  switch(sev) {
    case 'critical': return 'bg-danger';
    case 'high':     return 'bg-warning text-dark';
    case 'medium':   return 'bg-info text-dark';
    case 'low':      return 'bg-secondary';
    default:         return 'bg-light text-dark';
  }
}
const token = "{{ session.jwt_token }}";
async function loadReport() {
  const jobId = "{{ scan_id }}";
  const resp = await fetch("{{ api_report_url }}", {
        headers: { 'Authorization': 'Bearer ' + token }
    });
  const data = await resp.json();

  // status
  const status = data.status || 'unknown';
  const badge = document.getElementById('statusBadge');
  badge.textContent = status.toUpperCase();
  badge.classList.add(status === 'finished' ? 'bg-success' : 'bg-warning');

  // targets (results.httpx.parsed.host/path)
  const tlist = document.getElementById('targetsList');
      const entries = [];
      (data.results.httpx.parsed||[]).forEach(r=>{
        entries.push(r.url);
      });
      (data.results.ffuf_directorybruteforce.parsed||[]).forEach(p=>{
        entries.push(p.url);
      });
      [...new Set(entries)].forEach(u=>{
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = u;
        tlist.append(li);
      });

  // Discovered Ports, group by host
      const portsByHost = {};
      (data.results.nmap.parsed||[]).forEach(p=>{
        const host = p.host || p.ip;
        if (!portsByHost[host]) portsByHost[host] = [];
        portsByHost[host].push(p);
      });
      const portsAcc = document.getElementById('portsAccordion');
      Object.entries(portsByHost).forEach(([host, ports], i)=>{
        const hid = 'host'+i;
        const item = document.createElement('div');
        item.className = 'accordion-item';
        item.innerHTML = `
          <h2 class="accordion-header" id="h${hid}">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#c${hid}"
                    aria-expanded="false" aria-controls="c${hid}">
              ${host}
            </button>
          </h2>
          <div id="c${hid}" class="accordion-collapse collapse"
               aria-labelledby="h${hid}" data-bs-parent="#portsAccordion">
            <div class="accordion-body p-0">
              <ul class="list-group list-group-flush">
                ${ports.map(p=>
                  `<li class="list-group-item d-flex justify-content-between">
                     <span>${p.port} (${p.service})</span>
                     <span class="text-muted">${p.info||''}</span>
                   </li>`
                ).join('')}
              </ul>
            </div>
          </div>`;
        portsAcc.append(item);
      });

  // nuclei
  const vulns = data.results.nuclei.parsed||[];
  const counts = {critical:0, high:0, medium:0, low:0, info:0};
  vulns.forEach(v=> {
    const sev = (v.info && v.info.severity) || 'info';
    counts[sev] = (counts[sev]||0) + 1;
  });
   const ctx = document.getElementById('severityChart').getContext('2d');
      new Chart(ctx, {
        type:'doughnut',
        data:{
          labels: ['Critical','High','Medium','Low','Info'],
          datasets:[{ 
            data: [counts.critical,counts.high,counts.medium,counts.low,counts.info],
            backgroundColor: [
              '#dc3545', // critical
              '#fd7e14', // high
              '#ffc107', // medium
              '#6c757d', // low
              '#0d6efd'  // info
            ]
          }]
        }
      });

  const accord = document.getElementById('vulnAccordion');
  vulns.forEach((v,i) => {
    const id = `vuln${i}`;
    const severity = (v.info && v.info.severity) || 'info';
    const title = (v.info && (v.info.name || v.info["template-id"])) 
                  || `Vuln #${i+1}`;

    const header = document.createElement('h2');
    header.className = 'accordion-header';
    header.id = `heading${id}`;
    header.innerHTML = `
      <button class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse${id}"
              aria-expanded="false"
              aria-controls="collapse${id}">
        <span class="badge ${badgeClass(severity)} me-2">
          ${severity.toUpperCase()}
        </span>
        ${title}
      </button>`;

    const body = document.createElement('div');
    body.id = `collapse${id}`;
    body.className = 'accordion-collapse collapse';
    body.setAttribute('aria-labelledby', `heading${id}`);
    body.setAttribute('data-bs-parent', '#vulnAccordion');

    const rawReq  = v.request  || '<нет запроса>';
    const rawResp = v.response || '<нет ответа>';

    body.innerHTML = `
      <p><strong>Description:</strong> ${v.info.description}</p>
      <p><strong>Impact:</strong> ${v.info.impact}</p>
      <p><strong>Remediation:</strong> ${v.info.remediation}</p>
      <p><strong>References:</strong><br>
         ${v.info.reference.map(r=>`<a href="${r}" target="_blank">${r}</a>`).join('<br>')}
      </p>
      <div class="accordion-body">
        <h6>Raw Request:</h6>
        <pre class="small bg-light p-2"><code>${escapeHtml(rawReq)}</code></pre>
        <h6>Raw Response:</h6>
        <pre class="small bg-light p-2"><code>${escapeHtml(rawResp)}</code></pre>
      </div>`;

    const item = document.createElement('div');
    item.className = 'accordion-item mb-1';
    item.append(header, body);
    accord.append(item);
  });
}

function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}


document.addEventListener('DOMContentLoaded', loadReport);
</script>
{% endblock %}
